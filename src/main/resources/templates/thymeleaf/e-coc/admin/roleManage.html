<!-- 품목관리 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{thymeleaf/layout/layout}">

<th:block layout:fragment="content">

    <div class="row">
        <div class="col-md-12">권한관리</div>
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header pb-0">
                    <h5>관리자 > 권한관리</h5>
                    <span>Eye-CoC 시스템을 이용하기 위한 권한정보를 설정합니다.</span>
                    <span>권한정보 미설정시 모든 사용자는 'USER'권한만 가지고 있으며, 접속가능 화면에서 읽기만 가능합니다.</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            <div class="row col-12">
                                <label>사용자 목록</label>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="input-group p-1" style="background-color: #f5f7fb !important;">
                                        <span class="col-2 m-2 fw-bold">이름</span>
                                        <input class="form-control" type="text" id="schUserNm" name="schUserNm">
                                        <button class="btn btn-primary col-2" onclick="search()">검색</button>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div id="userGrid" style="width: 100%; height: 600px"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-8">
                            <!--<div class="row col-12">
                                <div class="form theme-form">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <div class="row col-12">
                                                    <label>권한</label>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-1" type="checkbox" class="chk_product" value="USER">
                                                            <label for="checkbox-primary-1" class="m-0" style="min-width: 150px;">일반사용자</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-P1612" type="checkbox" class="chk_product" value="P1612_MANAGER">
                                                            <label for="checkbox-primary-P1612" class="m-0" style="min-width: 150px;">전산기기구매 담당자</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-P1613" type="checkbox" class="chk_product" value="P1613_MANAGER">
                                                            <label for="checkbox-primary-P1613" class="m-0" style="min-width: 150px;">공사입찰관리 담당자</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-P1614" type="checkbox" class="chk_product" value="P1614_MANAGER">
                                                            <label for="checkbox-primary-P1614" class="m-0" style="min-width: 150px;">부산물관리 담당자</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-3" type="checkbox" class="chk_product" value="ADMIN">
                                                            <label for="checkbox-primary-3" class="m-0" style="min-width: 150px;">시스템관리자</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <div class="row col-12">
                                                    <label>세부권한</label>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-11" type="checkbox" class="chk_product" value="READ_AUTHORITY">
                                                            <label for="checkbox-primary-11" class="m-0">읽기만 가능</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-option" data-bs-toggle="buttons">
                                                    <div class="btn m-1 btn_prod_list btn-light">
                                                        <div class="checkbox checkbox-secondary">
                                                            <input id="checkbox-primary-12" type="checkbox" class="chk_product" value="WRITE_AUTHORITY">
                                                            <label for="checkbox-primary-12" class="m-0">등록/수정/삭제 가능</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="text-end">
                                                <button class="btn btn-secondary" type="button" onclick="updateProc()">저장</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>-->
                            <div class="row mb-3">
                                <div class="col-4">
                                    <label>권한정보</label>
                                </div>
                                <div class="col-8 text-end">
                                    <button type="button" class="btn btn-outline-light btn-xs" onclick="deleteSupMember()">선택삭제</button>
                                </div>
                                <div class="col-12">
                                    <div id="roleGrid" style="width: 100%; height: 600px"></div>
                                </div>
                                <!--<div class="col-12">
                                    <div class="text-end">
                                        <button class="btn btn-secondary" type="button" onclick="updateProc()">저장</button>
                                    </div>
                                </div>-->
                            </div>
                        </div>
                        <div class="col-12 text-end">
                            <button class="btn btn-secondary" type="button" onclick="updateProc()" sec:authorize="hasAnyAuthority('ADMIN', 'ADMIN_UPDATE')">저장</button>
                        </div>

                    </div>

                    <!--<div class="card-block row">
                        <div class="col-sm-12 col-lg-12 col-xl-12">
                            <div id="userGrid" style="width: 100%; height: 600px"></div>
                        </div>
                    </div>-->
                </div>

            </div>
        </div>
    </div>

    <script>
        var containerUser, providerUser, gridViewUser;
        var containerRole, providerRole, gridViewRole;
        document.addEventListener('DOMContentLoaded', function () {
            containerUser = document.getElementById('userGrid');
            providerUser = new RealGrid.LocalDataProvider(false);
            gridViewUser = new RealGrid.GridView(containerUser);
            gridViewUser.setDataSource(providerUser);

            // 필드 생성
            providerUser.setFields([
                {   fieldName: "userid",     dataType: "text",   },
                {   fieldName: "userNm",     dataType: "text",   },
                {   fieldName: "deptNm",     dataType: "text",   },
            ]);

            // 컬럼 생성
            gridViewUser.setColumns([
                {   name: "userid",      fieldName: "userid",     type: "data",   width: "90",   header: {   text: "아이디",  },  },
                {   name: "userNm",      fieldName: "userNm",     type: "data",   width: "125",   header: {   text: "이름",    },  },
                {   name: "deptNm",      fieldName: "deptNm",     type: "data",   width: "200",   header: {   text: "부서명",  },  },
            ]);

            //체크박스(false), 라디오버튼(true)
            gridViewUser.setCheckBar({  exclusive: true    });
            //상태바 표시여부
            gridViewUser.setStateBar({  visible: false  });
            //하단 소계 감추기
            gridViewUser.footers.visible = false;
            gridViewUser.editOptions.editable = false;

            gridViewUser.header.height = 36;
            gridViewUser.displayOptions.rowHeight = 36;

            gridViewUser.setColumnProperty("userNm", "autoFilter", true);

            gridViewUser.onCellClicked = function(grid, clickData) {
                gridViewRole.cancel();
                let data = gridViewUser.getValues(clickData.itemIndex);
                console.log(data);
                console.log(clickData);
                let params = {};
                params.userid = data.userid;

                gridViewUser.checkRow(clickData.itemIndex, true, true, true);

                providerRole.clearRows();
                ajaxJsonCall("/admin/selectRoleInfoByUid", params, function (data) {
                    if (data.fields.RESULT_CD == "S") {
                        if (data.fields.roleUserList.length == 0) {
                            toastrWarning("등록된 권한 정보가 없습니다.");
                            return;
                        }
                        //console.log(data);
                        providerRole.fillJsonData(data.fields.roleUserList, { fillMode: "set" });
                    } else {
                        toastrError(data.errMsg);
                    }
                });
            }



            //해당 사용자의 권한정보 조회
            // gridViewUser.onCellDblClicked = function(grid, clickData) {
            //     let data = gridViewUser.getValues(clickData.itemIndex);
            //     let params = {};
            //     params.userid = data.userid;
            //
            //     providerRole.clearRows();
            //     ajaxJsonCall("/admin/selectRoleInfoByUid", params, function (data) {
            //         if (data.fields.RESULT_CD == "S") {
            //             if (data.fields.roleUserList.length == 0) {
            //                 toastrWarning("등록된 권한 정보가 없습니다.");
            //                 return;
            //             }
            //             console.log(data);
            //             providerRole.fillJsonData(data.fields.roleUserList, { fillMode: "set" });
            //         } else {
            //             toastrError(data.errMsg);
            //         }
            //     });
            // }

            //유저 권한 정보
            containerRole = document.getElementById('roleGrid');
            providerRole = new RealGrid.LocalDataProvider(false);
            gridViewRole = new RealGrid.GridView(containerRole);
            gridViewRole.setDataSource(providerRole);

            // 필드 생성
            providerRole.setFields([
                {   fieldName: "legCd",         dataType: "text",   },
                {   fieldName: "roleId",        dataType: "text",   },
                {   fieldName: "roleNm",        dataType: "text",   },
                {   fieldName: "userid",        dataType: "text",   },
                {   fieldName: "aplyYn",         dataType: "text",  },
                {   fieldName: "readAble",      dataType: "text",   },
                {   fieldName: "writeAble",     dataType: "text",   },
                {   fieldName: "updateAble",    dataType: "text",   },
                {   fieldName: "deleteAble",    dataType: "text",   },
                {   fieldName: "downloadAble",  dataType: "text",   },
                {   fieldName: "fn1",           dataType: "text",   },
                {   fieldName: "fn2",           dataType: "text",   },
                {   fieldName: "fn3",           dataType: "text",   },
                {   fieldName: "fn4",           dataType: "text",   },
                {   fieldName: "fn5",           dataType: "text",   },
            ]);

            // 컬럼 생성
            gridViewRole.setColumns([
                {   name: "legCd",          fieldName: "legCd",          type: "data",   width: "90",   header: {   text: "Leg Cd",        },  editable: false,  visible: false,  },
                {   name: "roleId",         fieldName: "roleId",         type: "data",   width: "120",  header: {   text: "권한코드",      },  editable: false,  },
                {   name: "roleNm",         fieldName: "roleNm",         type: "data",   width: "150",  header: {   text: "권한명",        },  editable: false,  },
                {   name: "userid",         fieldName: "userid",         type: "data",   width: "90",   header: {   text: "사용자아이디",  },  editable: false,  visible: false,  },
                {   name: "aplyYn",         fieldName: "aplyYn",         type: "data",   width: "80",   header: {   text: "권한적용",      },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "readAble",       fieldName: "readAble",       type: "data",   width: "70",   header: {   text: "읽기",          },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "writeAble",      fieldName: "writeAble",      type: "data",   width: "70",   header: {   text: "등록",          },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "updateAble",     fieldName: "updateAble",     type: "data",   width: "70",   header: {   text: "수정",          },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "deleteAble",     fieldName: "deleteAble",     type: "data",   width: "70",   header: {   text: "삭제",          },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "downloadAble",   fieldName: "downloadAble",   type: "data",   width: "70",   header: {   text: "다운로드",      },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "fn1",            fieldName: "fn1",            type: "data",   width: "70",   header: {   text: "기타1",         },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "fn2",            fieldName: "fn2",            type: "data",   width: "70",   header: {   text: "기타2",         },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "fn3",            fieldName: "fn3",            type: "data",   width: "70",   header: {   text: "기타3",         },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "fn4",            fieldName: "fn4",            type: "data",   width: "70",   header: {   text: "기타4",         },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },
                {   name: "fn5",            fieldName: "fn5",            type: "data",   width: "70",   header: {   text: "기타5",         },  editable: false,  renderer: {  type: "check", trueValues: "Y", falseValues: "N"  },  },


            ]);

            //체크박스(false), 라디오버튼(true)
            gridViewRole.setCheckBar({  exclusive: true, visible: false    });
            //상태바 표시여부
            gridViewRole.setStateBar({  visible: false  });
            //하단 소계 감추기
            gridViewRole.footers.visible = false;
            gridViewRole.editOptions.editable = true;

            gridViewRole.header.height = 36;
            gridViewRole.displayOptions.rowHeight = 36;

            gridViewRole.onCellEdited = function (grid, itemIndex, row, field) {
                console.log('Edit done! at ' + itemIndex + ', ' + field);
                //console.log(gridViewRole.getValues(itemIndex));
                let rowData = gridViewRole.getValues(itemIndex);
                //권한적용 체크 해제시 해당 row 전체 체크 해제
                if (rowData.aplyYn == "N") {
                    gridViewRole.setValue(itemIndex, "readAble", "N");
                    gridViewRole.setValue(itemIndex, "writeAble", "N");
                    gridViewRole.setValue(itemIndex, "updateAble", "N");
                    gridViewRole.setValue(itemIndex, "deleteAble", "N");
                    gridViewRole.setValue(itemIndex, "downloadAble", "N");
                    gridViewRole.setValue(itemIndex, "fn1", "N");
                    gridViewRole.setValue(itemIndex, "fn2", "N");
                    gridViewRole.setValue(itemIndex, "fn3", "N");
                    gridViewRole.setValue(itemIndex, "fn4", "N");
                    gridViewRole.setValue(itemIndex, "fn5", "N");
                }
                //ADMIN 권한적용 체크 시 해당 row 전체 체크
                else if (rowData.aplyYn == "Y" && rowData.roleId == "ADMIN") {
                    gridViewRole.setValue(itemIndex, "readAble", "Y");
                    gridViewRole.setValue(itemIndex, "writeAble", "Y");
                    gridViewRole.setValue(itemIndex, "updateAble", "Y");
                    gridViewRole.setValue(itemIndex, "deleteAble", "Y");
                    gridViewRole.setValue(itemIndex, "downloadAble", "Y");
                    gridViewRole.setValue(itemIndex, "fn1", "Y");
                    gridViewRole.setValue(itemIndex, "fn2", "Y");
                    gridViewRole.setValue(itemIndex, "fn3", "Y");
                    gridViewRole.setValue(itemIndex, "fn4", "Y");
                    gridViewRole.setValue(itemIndex, "fn5", "Y");
                }

            }

            search();
        });
        function search() {

            providerUser.clearRows();
            providerRole.clearRows();
            let params = {};
            params.userNm = $("#schUserNm").val();

            ajaxJsonCall("/admin/selectUserList", params, function (data) {
                if (data.fields.RESULT_CD == "S") {
                    if (data.fields.userList.length == 0) {
                        toastrWarning("등록된 사용자가 없습니다..");
                        return;
                    }

                    providerUser.fillJsonData(data.fields.userList, { fillMode: "set" });
                } else {
                    toastrError(data.errMsg);
                }
            });
        }

        function updateProc() {
            gridViewUser.commit();
            gridViewRole.commit();

            let userData = providerUser.getJsonRow(gridViewUser.getCheckedRows()[0]);
            let roleDatas = providerRole.getJsonRows(0, -1);

            let params = {};
            params.userid = userData.userid;
            params.roleList = roleDatas;
            //console.log(params);

            ajaxJsonCall("/admin/updateUserRoleInfo", params, function (data) {
                if (data.fields.RESULT_CD == "S") {
                    toastrSuccess();
                } else {
                    toastrError(data.errMsg);
                }
            });
        }
    </script>
</th:block>
</html>